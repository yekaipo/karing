name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      build-type:
        description: 'Build type (debug/release)'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle
    
    # 第一步：检查是否是有效的Gradle项目
    - name: Validate Gradle Project
      id: validate-gradle
      run: |
        if [ -f "settings.gradle.kts" ] || [ -f "build.gradle.kts" ] || [ -f "settings.gradle" ] || [ -f "build.gradle" ]; then
          echo "is_gradle_project=true" >> $GITHUB_OUTPUT
        else
          echo "is_gradle_project=false" >> $GITHUB_OUTPUT
        fi
    
    # 第二步：如果不是Gradle项目，先初始化
    - name: Initialize Gradle Project
      if: steps.validate-gradle.outputs.is_gradle_project == 'false'
      run: |
        echo "Initializing new Gradle project..."
        gradle init --type kotlin-application --dsl kotlin --no-daemon
        ./gradlew wrapper --gradle-version 8.2
        chmod +x gradlew
    
    # 第三步：确保Wrapper存在（适用于已有项目）
    - name: Setup Gradle Wrapper
      if: steps.validate-gradle.outputs.is_gradle_project == 'true'
      run: |
        if [ ! -f "gradlew" ]; then
          ./gradlew wrapper --gradle-version 8.2
        fi
        chmod +x gradlew
    
    - name: Build with Gradle
      run: ./gradlew build
